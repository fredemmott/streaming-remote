# RPC Protocol

The RPC protocol is an encrypted JSON-RPC protocol.

## Wire format and encryption

Once the [handshake protocol](handshake_protocol.md) is complete, both the client and server
have state objects for both client-to-server and server-to-client message encryption.

1. A JSON string is produced containing the JSON-RPC message
1. This string is converted to UTF-8, with no leading or trailing whitespace, and no trailing
   null byte.
1. The resulting blob is encrypted using `crypto_secretstream_xchacha20poly1305_push()`
1. The receiving end decrypts the blob using `crypto_secretstream_xchacha20poly1305_pull()` and decodes the JSON

## Overview of JSON-RPC

See the [full specification](https://www.jsonrpc.org/specification) for details.

JSON-RPC provides 3 main kinds of message:
- requests
- responses
- notifications

### Requests

A request has the form:

```
{
  "jsonrpc" : "2.0",
  "id" : string|int|null, // generated by requestor
  "method" : string,
  "params" ?: array|object, // method-specific
}
```

### Responses

A request has the form:

```
{
  "jsonrpc" : "2.0",
  "id" : (string|int|null), // matches request
  "result" ?: mixed, // method-specific
  "error" ?: {
    "code" : int,
    "message" : string,
    "data" ?: mixed, // method-specific
  },
}
```

- Either result or error will be set
- result **must** be set on success and unset on error
- error **must** be set on error and unset on success

### Notifications

Notifications are like commands, but do not have an ID, and no response is expected.

```
{
  "jsonrpc": "2.0",
  "method": string,
  "params" ?: array|object, // method-specific
}
```

## Types

### `OutputType`

```
OutputType = "unknown" | "local_recording" | "local_stream" | "remote_stream"
```

NDI is an example of a local stream.

### `OutputState`

```
OutputState = "unknown" | "starting" | "active" | "stopping" | "stopped"
```

### `Output`

```
Output = {
  id: string,
  name: string,
  type: OutputType,
  state: OutputState,
  delaySeconds ?: int,
}
```

The 'id' is an opaque string to uniquely identify the output. The `name` is suitable for displaying to the end user.

If `delaySeconds` is 0, there is no delay. If `delaySeconds` is negative or absent,
delay is not supported. Implementations *should* omit `delaySeconds` for outputs
where it is not supported.

## Server-To-Client Notifications

### `hello`

This notification is sent by the server as soon as the handshake protocol is complete. No response is required - however
clients are likely to want to make requests such as `outputs/get` after receiving this.

This notification has no parameters.

Example:

```
{
  "jsonrpc": "2.0",
  "method": "hello"
}
```

### `outputs/stateChanged`

This notification is sent by the server when the state of an output changes.

This notification has two parameters:

- `id: string`: the ID of the output
- `state: OutputState`: the new state of the output

Example:

```
{
  "jsonrpc": "2.0",
  "method": "outputs/stateChanged",
  "params": {
    "id": "twitch://fredemmott",
    "state": "starting"
  }
}
```

## Client-To-Server Requests

### `outputs/get`

The client invokes this method when it wants information on the available outputs.

This method has no parameters.

This method returns a map from output ID to `Output` objects.

Example request:

```
{
  "jsonrpc": "2.0",
  "method": "outputs/get",
  "id": 1
}
```

Example response:

```
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "recording": {
      "id": "recording",
      "name': "Local Recording",
      "type": "local_recording",
      "state": "active"
    },
    "twitch://fredemmott" {
      "id": "twitch://fredemmott",
      "name": "Twitch",
      "type": "remote_stream",
      "state": "stopped",
      "delaySeconds": 0
    },
    "ndi" {
      "id": "ndi",
      "name": "NDI Broadcast",
      "type": "local_stream",
      "state": "starting"
    }
  }
}
```

### `outputs/start`

This method is sent by the client when it wants to start an output (recording or stream).

This method takes `{ id: string }` for its' parameters.

Success indicates that the software was asked to start the output - however, this can take some time,
so clients *should not* consider the state of the output to have changed until they receive an `outputs/stateChanged`
notification.

Example request:

```
{
  "jsonrpc": "2.0",
  "method": "outputs/start",
  "id": "startTwitch/1",
  "params": { "id": "twitch://fredemmott" }
}
```

Example response and notifications:

```
{
  "jsonrpc": "2.0",
  "id": "startTwitch/1",
  "result": {}
}
{
  "jsonrpc": "2.0",
  "method": "outputs/stateChanged",
  "params": {
    "id": "twitch://fredemmott",
    "state": "starting"
  }
}
{
  "jsonrpc": "2.0",
  "method": "outputs/stateChanged",
  "params": {
    "id": "twitch://fredemmott",
    "state": "active"
  }
}
```

There is likely to be a significant amount of time between receiving success and receiving the notifications.

### `outputs/stop`

This method is sent by the client when it wants to stop an output (recording or stream).

This method takes `{ id: string }` for its' parameters.

Success indicates that the software was asked to stop the output - however, this can take some time,
so clients *should not* consider the state of the output to have changed until they receive an `outputs/stateChanged`
notification.

Example request:

```
{
  "jsonrpc": "2.0",
  "method": "outputs/stop",
  "id": "stopTwitch/1",
  "params": { "id": "twitch://fredemmott" }
}
```

Example response and notifications:

```
{
  "jsonrpc": "2.0",
  "id": "stopTwitch/1",
  "result": {}
}
{
  "jsonrpc": "2.0",
  "method": "outputs/stateChanged",
  "params": {
    "id": "twitch://fredemmott",
    "state": "stopping"
  }
}
{
  "jsonrpc": "2.0",
  "method": "outputs/stateChanged",
  "params": {
    "id": "twitch://fredemmott",
    "state": "stopped"
  }
}
```

There is likely to be a significant amount of time between receiving success and receiving the notifications.
